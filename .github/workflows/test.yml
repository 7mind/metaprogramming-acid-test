name: Test Metaprogramming Implementations

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Test Rust Functoid
  test-rust-functoid:
    name: Test Rust Functoid
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Test Rust Functoid
        working-directory: ./rust/functoid
        run: |
          nix develop --command cargo test --verbose
          nix develop --command cargo test --doc --verbose

      - name: Run Rust Functoid examples
        working-directory: ./rust/functoid
        run: |
          nix develop --command cargo run --example basic_usage
          nix develop --command cargo run --example type_tags_demo

  # Test Kotlin Functoid
  test-kotlin-functoid:
    name: Test Kotlin Functoid
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Test Kotlin Functoid
        working-directory: ./kotlin/functoid
        run: |
          nix develop --command gradle test --info

      - name: Run Kotlin Functoid examples
        working-directory: ./kotlin/functoid
        run: |
          nix develop --command gradle run

  # Test Rust Structured Logging
  test-rust-structured-logging:
    name: Test Rust Structured Logging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Rust Structured Logging exists
        id: check_rust_logging
        run: |
          if [ -f "rust/structured_logging/Cargo.toml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check_rust_logging.outputs.exists == 'true'
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        if: steps.check_rust_logging.outputs.exists == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Test Rust Structured Logging
        if: steps.check_rust_logging.outputs.exists == 'true'
        working-directory: ./rust/structured_logging
        run: |
          nix develop --command cargo test --verbose
          nix develop --command cargo test --doc --verbose

      - name: Run Rust Structured Logging examples
        if: steps.check_rust_logging.outputs.exists == 'true'
        working-directory: ./rust/structured_logging
        run: |
          nix develop --command cargo run --example basic_usage
          nix develop --command cargo run --example advanced_usage

  # Test Python Structured Logging
  test-python-structured-logging:
    name: Test Python Structured Logging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Python Structured Logging exists
        id: check_python_logging
        run: |
          if [ -f "python/structured_logging/logger.py" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check_python_logging.outputs.exists == 'true'
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        if: steps.check_python_logging.outputs.exists == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Run Python Structured Logging example
        if: steps.check_python_logging.outputs.exists == 'true'
        working-directory: ./python/structured_logging
        run: |
          python3 example.py

      - name: Test Python imports
        if: steps.check_python_logging.outputs.exists == 'true'
        run: |
          cd python/structured_logging
          python3 -c "from logger import logger; print('Import successful')"

  # Test C++ All Challenges
  test-cpp-all-challenges:
    name: Test C++ All Challenges
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if C++ implementation exists
        id: check_cpp
        run: |
          if [ -f "cpp/metaprogramming-challenges/CMakeLists.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check_cpp.outputs.exists == 'true'
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        if: steps.check_cpp.outputs.exists == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Build C++ implementation
        if: steps.check_cpp.outputs.exists == 'true'
        working-directory: ./cpp/metaprogramming-challenges
        run: |
          nix develop --command bash -c "cmake -B build -G Ninja && cmake --build build"

      - name: Run C++ tests
        if: steps.check_cpp.outputs.exists == 'true'
        working-directory: ./cpp/metaprogramming-challenges
        run: |
          nix develop --command ctest --test-dir build --output-on-failure

      - name: Run C++ examples
        if: steps.check_cpp.outputs.exists == 'true'
        working-directory: ./cpp/metaprogramming-challenges
        run: |
          nix develop --command bash -c "./build/example_all"

  # Test Haskell All Challenges
  test-haskell-all-challenges:
    name: Test Haskell All Challenges
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Haskell implementation exists
        id: check_haskell
        run: |
          if [ -f "haskell/metaprogramming-challenges/metaprogramming-challenges.cabal" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check_haskell.outputs.exists == 'true'
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        if: steps.check_haskell.outputs.exists == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Build Haskell implementation
        if: steps.check_haskell.outputs.exists == 'true'
        working-directory: ./haskell/metaprogramming-challenges
        run: |
          nix develop --command cabal build

      - name: Run Haskell tests
        if: steps.check_haskell.outputs.exists == 'true'
        working-directory: ./haskell/metaprogramming-challenges
        run: |
          nix develop --command cabal test

      - name: Run Haskell examples
        if: steps.check_haskell.outputs.exists == 'true'
        working-directory: ./haskell/metaprogramming-challenges
        run: |
          nix develop --command cabal run example-all

  # Test Zig All Challenges
  test-zig-all-challenges:
    name: Test Zig All Challenges
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Zig implementation exists
        id: check_zig
        run: |
          if [ -f "zig/metaprogramming-challenges/build.zig" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check_zig.outputs.exists == 'true'
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        if: steps.check_zig.outputs.exists == 'true'
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Run Zig tests
        if: steps.check_zig.outputs.exists == 'true'
        working-directory: ./zig/metaprogramming-challenges
        run: |
          nix develop --command zig build test

      - name: Run Zig examples
        if: steps.check_zig.outputs.exists == 'true'
        working-directory: ./zig/metaprogramming-challenges
        run: |
          nix develop --command zig build run-examples

  # Verify all implementations
  verify:
    name: Verify All Tests
    runs-on: ubuntu-latest
    needs:
      - test-rust-functoid
      - test-kotlin-functoid
      - test-zig-all-challenges
    steps:
      - name: All tests passed
        run: echo "All required tests passed successfully"
